<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="BbsMapper">

    <!-- Beans의 멤버변수(property)이름과 대상 테이블의 컬럼(column)을 연결한다. -->
    <resultMap id="bbsMap"
        type="kr.co.poppy.model.Bbs">
        <result property="bbsno"        column="bbsno" />
        <result property="bbstype"        column="bbstype" />
        <result property="bbstitle"       column="bbstitle" />
        <result property="bbscontent"       column="bbscontent" />
        <result property="qnasec"         column="qnasec" />
        <result property="qnapw"         column="qnapw" />
        <result property="rvlike"         column="rvlike" />
        <result property="regdate"       column="regdate" />
        <result property="editdate"      column="editdate" />
        <result property="memno"         column="memno" />
        <result property="goodsno"         column="goodsno" />
    </resultMap>
    
   <!-- 단일행 조회를 위한 기능 정의1 -->
   <!-- QNA / 포토리뷰 글 보기 페이지 -->
    <select id="selectItem1"
        parameterType="kr.co.poppy.model.Bbs"
        resultMap="bbsMap">
        SELECT bbsno, bbstype, bbstitle, bbscontent, qnasec, qnapw, rvlike,
               DATE_FORMAT(regdate, '%Y-%m-%d') AS regdate,
               DATE_FORMAT(editdate, '%Y-%m-%d') AS editdate
   			   b.memno, m.username, m.userid, g.goodsno, g.gname
        FROM bbs b
        INNER JOIN members m ON b.memno=m.memno
        INNER JOIN goods g ON b.goodsno=g.goodsno;
        WHERE bbstype=#{bbstype} and bbsno=#{bbsno}
    </select>
    
    <!-- 단일행 조회를 위한 기능 정의2 -->
     <!-- 공지사항 글 보기 페이지 -->
    <select id="selectItem2"
        parameterType="kr.co.poppy.model.Bbs"
        resultMap="bbsMap">
        SELECT bbsno, bbstype, bbstitle, bbscontent,
               DATE_FORMAT(regdate, '%Y-%m-%d') AS regdate,
               DATE_FORMAT(editdate, '%Y-%m-%d') AS editdate,
   			   b.memno, m.username, m.userid
        FROM bbs b
        INNER JOIN members m ON b.memno=m.memno
        WHERE bbstype=#{bbstype} and bbsno=#{bbsno}
    </select>
    
    
    <!-- 다중행 조회를 위한 기능 정의1 -->
    <!--  QNA / 포토리뷰 글 목록 페이지 -->
    <select id="selectList1"
        parameterType="kr.co.poppy.model.Bbs"
        resultMap="bbsMap">
        SELECT bbsno, bbstype, bbstitle, bbscontent, qnasec, qnapw, rvlike,
               DATE_FORMAT(regdate, '%Y-%m-%d') AS regdate,
               DATE_FORMAT(editdate, '%Y-%m-%d') AS editdate,
   			   b.memno, m.username, m.userid, g.goodsno, g.gname
        FROM bbs b
        INNER JOIN members m ON b.memno=m.memno
        INNER JOIN goods g ON b.goodsno=g.goodsno;
        WHERE bbstype=#{bbstype}
        
        <where>
            <if test="bbscontent != null and bbscontent != ''">
                bbscontent LIKE concat('%', #{bbscontent}, '%')
            </if>
            <if test="bbstitle != null and bbstitle != ''">
                bbstitle LIKE concat('%', #{bbstitle}, '%')
            </if>
            <if test="username != null and username != ''">
                username LIKE concat('%', #{username}, '%')
            </if>
            <if test="userid != null and userid != ''">
                userid LIKE concat('%', #{userid}, '%')
            </if>
        </where>
        
        ORDER BY bbsno DESC
        
        <if test="listCount > 0">
            LIMIT #{offset}, #{listCount}
        </if>
    </select>
    
    <!-- 다중행 조회를 위한 기능 정의2 -->
    <!-- 공지사항 글 목록 페이지 -->
    <select id="selectList2"
        parameterType="kr.co.poppy.model.Bbs"
        resultMap="bbsMap">
        SELECT bbsno, bbstype, bbstitle, bbscontent,
               DATE_FORMAT(regdate, '%Y-%m-%d') AS regdate,
               DATE_FORMAT(editdate, '%Y-%m-%d') AS editdate,
   			   b.memno, m.username, m.userid
        FROM bbs b
        INNER JOIN members m ON b.memno=m.memno
        WHERE bbstype=#{bbstype}
        
        <where>
            <if test="bbscontent != null and bbscontent != ''">
                bbscontent LIKE concat('%', #{bbscontent}, '%')
            </if>
            <if test="bbstitle != null and bbstitle != ''">
                bbstitle LIKE concat('%', #{bbstitle}, '%')
            </if>
            <if test="username != null and username != ''">
                username LIKE concat('%', #{username}, '%')
            </if>
            <if test="userid != null and userid != ''">
                userid LIKE concat('%', #{userid}, '%')
            </if>
        </where>
        
        ORDER BY bbsno DESC
        
        <if test="listCount > 0">
            LIMIT #{offset}, #{listCount}
        </if>
    </select>
    
    <!-- 데이터 수 조회를 위한 기능 정의 -->
    <select id="selectCountAll"
        parameterType="kr.co.poppy.model.Bbs" resultType="int">
        SELECT COUNT(*)
        FROM bbs b
        INNER JOIN members m ON b.memno=m.memno
        INNER JOIN goods g ON b.goodsno=g.goodsno;
        WHERE bbstype=#{bbstype}
        
        <where>
            <if test="bbscontent != null and bbscontent != ''">
                bbscontent LIKE concat('%', #{bbscontent}, '%')
            </if>
            <if test="bbstitle != null and bbstitle != ''">
                bbstitle LIKE concat('%', #{bbstitle}, '%')
            </if>
            <if test="username != null and username != ''">
                username LIKE concat('%', #{username}, '%')
            </if>
            <if test="userid != null and userid != ''">
                userid LIKE concat('%', #{userid}, '%')
            </if>
        </where>
    </select>

    <!-- 데이터 저장을 위한 기능 정의 -->
    <insert id="insertItem"
        parameterType="kr.co.poppy.model.Bbs"
        useGeneratedKeys="true" keyProperty="bbsno">
        INSERT INTO bbs (
            bbstype, bbstitle, bbscontent, qnasec, qnapw, rvlike, regdate, editdate, memno, goodsno
        ) VALUES (
            #{bbstype}, #{bbstitle}, #{bbscontent}, #{qnasec}, #{qnapw}, #{rvlike}, #{regdate}, #{editdate}, #{memno}, #{goodsno}
        )
    </insert>

    <!-- 데이터 삭제를 위한 기능 정의 -->
    <delete id="deleteItem"
        parameterType="kr.co.poppy.model.Bbs">
        DELETE FROM professor WHERE bbsno=#{bbsno}
    </delete>

    <!-- 데이터 갱신을 위한 기능 정의 -->
    <update id="updateItem"
        parameterType="kr.co.poppy.model.Bbs">
        UPDATE bbs SET
            bbstype=#{bbstype}, bbstitle=#{bbstitle}, bbscontent=#{bbscontent}, qnasec=#{qnasec}, qnapw=#{qnapw}, rvlike=#{rvlike}, 
            regdate=#{regdate}, editdate=#{editdate}, memo=#{memno}, goodsno=#{goodsno}
        WHERE bbsno=#{bbsno}
   </update>
   
   <!-- 특정 멤버를 참조하는 Bbs데이터를 모두 참조 해제한다. -->
   <update id="unsetMembers"
   		parameterType="kr.co.poppy.model.Members">
   		UPDATE bbs SET memno=null WHERE memno=#{memno}
   </update>
</mapper>